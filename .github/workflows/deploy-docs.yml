name: Deploy Docs

on:
  workflow_run:
    workflows: ["Release"]
    types: [completed]
  workflow_dispatch:
    inputs:
      ref:
        description: 'Tag or branch to build docs from'
        required: true
        default: 'master'

jobs:
  deploy-docs:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && inputs.ref || github.event.workflow_run.head_sha }}

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Configure Maven settings
        run: |
          mkdir -p ~/.m2
          cat > ~/.m2/settings.xml << EOF
          <settings>
            <servers>
              <server>
                <id>bloomreach-maven2</id>
                <username>${BR_MAVEN_USERNAME}</username>
                <password>${BR_MAVEN_PASSWORD}</password>
              </server>
              <server>
                <id>bloomreach-maven2-forge</id>
                <username>${BR_MAVEN_USERNAME}</username>
                <password>${BR_MAVEN_PASSWORD}</password>
              </server>
              <server>
                <id>bloomreach-maven2-enterprise</id>
                <username>${BR_MAVEN_USERNAME}</username>
                <password>${BR_MAVEN_PASSWORD}</password>
              </server>
            </servers>
          </settings>
          EOF
        env:
          BR_MAVEN_USERNAME: ${{ secrets.BR_MAVEN_USERNAME }}
          BR_MAVEN_PASSWORD: ${{ secrets.BR_MAVEN_PASSWORD }}

      - name: Build site
        run: mvn -B site -Pgithub.pages
        env:
          BR_MAVEN_USERNAME: ${{ secrets.BR_MAVEN_USERNAME }}
          BR_MAVEN_PASSWORD: ${{ secrets.BR_MAVEN_PASSWORD }}

      - name: Deploy site to gh-pages
        run: |
          if [ ! -d "docs" ]; then
            echo "ERROR: Site build did not produce docs/ directory"
            exit 1
          fi
          cp -r docs/ /tmp/site-docs/

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Switch to gh-pages (create if needed)
          git fetch origin gh-pages:gh-pages 2>/dev/null || git checkout --orphan gh-pages
          git checkout gh-pages

          # Replace site content
          git rm -rf . 2>/dev/null || true
          cp -r /tmp/site-docs/* .
          git add -A
          git diff --staged --quiet || git commit -m "releasing ${{ github.event_name == 'workflow_dispatch' && inputs.ref || github.event.workflow_run.head_branch }}: regenerate docs"
          git push origin gh-pages
