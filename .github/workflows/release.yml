name: Release

on:
  push:
    tags:
      - '[0-9]+.[0-9]+.[0-9]+'

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Configure Maven settings
        run: |
          mkdir -p ~/.m2
          cat > ~/.m2/settings.xml << EOF
          <settings>
            <servers>
              <server>
                <id>bloomreach-maven2</id>
                <username>${BR_MAVEN_USERNAME}</username>
                <password>${BR_MAVEN_PASSWORD}</password>
              </server>
              <server>
                <id>bloomreach-maven2-forge</id>
                <username>${BR_MAVEN_USERNAME}</username>
                <password>${BR_MAVEN_PASSWORD}</password>
              </server>
              <server>
                <id>bloomreach-maven2-enterprise</id>
                <username>${BR_MAVEN_USERNAME}</username>
                <password>${BR_MAVEN_PASSWORD}</password>
              </server>
            </servers>
          </settings>
          EOF
        env:
          BR_MAVEN_USERNAME: ${{ secrets.BR_MAVEN_USERNAME }}
          BR_MAVEN_PASSWORD: ${{ secrets.BR_MAVEN_PASSWORD }}

      - name: Verify version matches tag
        run: |
          POM_VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          if [ "$POM_VERSION" != "${{ github.ref_name }}" ]; then
            echo "ERROR: Tag '${{ github.ref_name }}' does not match pom version '$POM_VERSION'"
            exit 1
          fi
        env:
          BR_MAVEN_USERNAME: ${{ secrets.BR_MAVEN_USERNAME }}
          BR_MAVEN_PASSWORD: ${{ secrets.BR_MAVEN_PASSWORD }}

      - name: Verify demo version matches tag
        run: |
          DEMO_VERSION=$(mvn -f demo help:evaluate -Dexpression=project.version -q -DforceStdout)
          if [ "$DEMO_VERSION" != "${{ github.ref_name }}" ]; then
            echo "ERROR: Tag '${{ github.ref_name }}' does not match demo pom version '$DEMO_VERSION'"
            exit 1
          fi
        env:
          BR_MAVEN_USERNAME: ${{ secrets.BR_MAVEN_USERNAME }}
          BR_MAVEN_PASSWORD: ${{ secrets.BR_MAVEN_PASSWORD }}

      - name: Build and test
        run: mvn -B clean install
        env:
          BR_MAVEN_USERNAME: ${{ secrets.BR_MAVEN_USERNAME }}
          BR_MAVEN_PASSWORD: ${{ secrets.BR_MAVEN_PASSWORD }}

      - name: Build and test demo
        run: mvn -B -f demo clean verify
        env:
          BR_MAVEN_USERNAME: ${{ secrets.BR_MAVEN_USERNAME }}
          BR_MAVEN_PASSWORD: ${{ secrets.BR_MAVEN_PASSWORD }}

      - name: Deploy to Forge repository
        run: mvn -B deploy -DskipTests
        env:
          BR_MAVEN_USERNAME: ${{ secrets.BR_MAVEN_USERNAME }}
          BR_MAVEN_PASSWORD: ${{ secrets.BR_MAVEN_PASSWORD }}

      - name: Create GitHub Release
        run: gh release create "${{ github.ref_name }}" --generate-notes
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build site
        run: mvn -B clean site -Pgithub.pages
        env:
          BR_MAVEN_USERNAME: ${{ secrets.BR_MAVEN_USERNAME }}
          BR_MAVEN_PASSWORD: ${{ secrets.BR_MAVEN_PASSWORD }}

      - name: Commit site to master
        run: |
          # Preserve generated docs
          if [ ! -d "docs" ]; then
            echo "ERROR: Site build did not produce docs/ directory"
            exit 1
          fi
          cp -r docs/ /tmp/site-docs/

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin master
          git checkout master

          # Restore generated docs
          rm -rf docs/
          cp -r /tmp/site-docs/ docs/

          git add docs/
          git diff --staged --quiet || git commit -m "releasing ${{ github.ref_name }}: regenerate docs"
          git push origin master
