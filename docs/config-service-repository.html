<!DOCTYPE html>
    <!--
 | Generated by Apache Maven Doxia Site Renderer 2.0.0 at $dateFormat.format( $currentDate ) 
 | Rendered using Bloomreach Forge Maven Skin 3.2.1 based on Apache Maven Fluido Skin
-->

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="" lang="">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
                      <meta http-equiv="Content-Language" content="" />
      <title>ConfigServiceRepository - Production Parity Testing â€“ B.R.U.T: BloomReach Unit Testing for brXM Delivery Tier</title>
  <link rel="stylesheet" href="./css/forge-maven-skin-syntaxhighlighter-3.2.1.min.css"/>
  <link rel="stylesheet" href="./css/forge-maven-skin-3.2.1.min.css"/>
  <link rel="stylesheet" href="./css/site.css" />
  <link rel="stylesheet" href="./css/print.css" media="print" />
  <link rel="icon" type="image/png" href="./images/skin/logo_64.png" sizes="64x64">

  
  <script type="text/javascript" src="./js/forge-maven-skin-syntaxhighlighter-3.2.1.min.js"></script>
  <script type="text/javascript" src="./js/forge-maven-skin-3.2.1.min.js"></script>

            <style>.github-fork-ribbon:before { background-color: green; }</style>
</head>
<body class="topBarDisabled">
              <a target="_blank" class="github-fork-ribbon right" href="https://github.com/bloomreach-forge/brut"
     data-ribbon="Fork me on GitHub" title="Fork me on GitHub">Fork me on GitHub</a>
          <div class="container-fluid">
  <div id="banner">
    <div id="logo">
                        <a href="https://bloomreach-forge.github.io">
        <img src="./images/skin/logo.png" alt="Bloomreach Forge Logo" />
      </a>
    </div>
    <div class="pull-left">                    <h1>        Bloomreach Unit Testing Library
        </h1>            </div>
    <div class="pull-right"></div>
    <div class="clear"><hr/></div>
  </div>

  <div id="breadcrumbs">
                            <div class="links">
      <a href="https://xmdocumentation.bloomreach.com">xmdocumentation.bloomreach.com</a>
      <a href="https://github.com/bloomreach-forge">github.com/bloomreach-forge</a>
    </div>
    <ul class="breadcrumb">
    
  <li id="publishDate">published: $dateValue  
  </li>
  
        
            </ul>
    <div class="clear"><hr/></div>
  </div>
<div class="row-fluid">
  <div id="leftColumn" class="span2">
    <div class="well sidebar-nav">
    
    <ul class="nav nav-list">
            <li class="nav-header">Getting Started</li>
              <li>  <a href="index.html" title="Home">  <span class="none"></span>  Home</a>  </li>
        <li>  <a href="install.html" title="Installation">  <span class="none"></span>  Installation</a>  </li>
        <li>  <a href="getting-started.html" title="Quick Start">  <span class="none"></span>  Quick Start</a>  </li>
                  <li class="nav-header">Testing Guides</li>
              <li>  <a href="testing/jaxrs-testing.html" title="JAX-RS Testing">  <span class="none"></span>  JAX-RS Testing</a>  </li>
        <li>  <a href="testing/pagemodel-testing.html" title="Page Model Testing">  <span class="none"></span>  Page Model Testing</a>  </li>
        <li>  <a href="testing/component-testing.html" title="Component Testing">  <span class="none"></span>  Component Testing</a>  </li>
        <li>  <a href="testing/stubbing-data.html" title="Test Data (YAML)">  <span class="none"></span>  Test Data (YAML)</a>  </li>
                  <li class="nav-header">Patterns</li>
              <li>  <a href="patterns/authentication.html" title="Authentication">  <span class="none"></span>  Authentication</a>  </li>
        <li>  <a href="patterns/common-patterns.html" title="Common Patterns">  <span class="none"></span>  Common Patterns</a>  </li>
                  <li class="nav-header">Reference</li>
              <li>  <a href="quick-reference.html" title="Quick Reference">  <span class="none"></span>  Quick Reference</a>  </li>
        <li class="active">  <a href="#"><span class="none"></span>ConfigService Repository</a>
  </li>
        <li>  <a href="architecture.html" title="Architecture">  <span class="none"></span>  Architecture</a>  </li>
        <li>  <a href="troubleshooting.html" title="Troubleshooting">  <span class="none"></span>  Troubleshooting</a>  </li>
        <li>  <a href="legacy-api.html" title="Legacy API">  <span class="none"></span>  Legacy API</a>  </li>
        <li>  <a href="apidocs/index.html" title="JavaDocs">  <span class="none"></span>  JavaDocs</a>  </li>
                  <li class="nav-header">Project</li>
              <li>  <a href="demoproject.html" title="Demo Project">  <span class="none"></span>  Demo Project</a>  </li>
        <li>  <a href="release-notes.html" title="Release Notes">  <span class="none"></span>  Release Notes</a>  </li>
        </ul>
    
          <hr />
      <div id="poweredBy">
                <div class="clear"></div>
                <div class="clear"></div>
                <div class="clear"></div>
                <div class="clear"></div>
          <a href="http://maven.apache.org/" title="$i18n.getString( "site-renderer", $locale, "template.builtby" ) Maven" class="poweredBy">  <img class="builtBy" alt="$i18n.getString( "site-renderer", $locale, "template.builtby" ) Maven" src="./images/logos/maven-feather.png" />  </a>
        </div>
    </div>
  </div>
  <div id="bodyColumn"  class="span10" >
    
  

    <section><a id="ConfigServiceRepository"></a>
<h1>ConfigServiceRepository</h1>
      
<p><code>ConfigServiceRepository</code> leverages brXM's production <code>ConfigurationConfigService</code>
      to create HST configuration in tests, providing production-identical JCR structure without manual node construction.</p>

      
<p><strong>Key Benefits:</strong></p>
      
<ul>
        
<li><strong>Production Parity</strong>: Uses exact same bootstrap code as real brXM</li>
        
<li><strong>Zero Maintenance</strong>: brXM structure changes propagate automatically</li>
        
<li><strong>Explicit Control</strong>: Loads only your test HCM modules (no framework dependencies)</li>
        
<li><strong>Proven</strong>: Works with both JAX-RS and PageModel tests</li>
      </ul>
    </section>

    <section><a id="Annotation-Based_Usage_.28Recommended.29"></a>
<h1>Annotation-Based Usage (Recommended)</h1>
      
<p>With BRUT 5.1.0+, ConfigServiceRepository integration is a one-liner via the <code>loadProjectContent</code> attribute:</p>

      
<div class="brush: java">
        
<pre><code>
@BrxmJaxrsTest(
    beanPackages = {&quot;org.example.model&quot;},
    resources = {MyResource.class},
    loadProjectContent = true  // Enables ConfigServiceRepository
)
class MyTest {

    @Test
    void testEndpoint(DynamicJaxrsTest brxm) {
        brxm.request()
            .get(&quot;/site/api/my-endpoint&quot;)
            .assertStatus(200);
    }
}
        </code></pre>
      </div>

      
<p><strong>What <code>loadProjectContent = true</code> does:</strong></p>
      
<ul>
        
<li>Auto-detects your project namespace from <code>pom.xml</code> <code>groupId</code></li>
        
<li>Loads HCM modules from <code>target/test-classes/META-INF/hcm-module.yaml</code></li>
        
<li>Creates production-identical HST configuration</li>
        
<li>All without manual Spring XML configuration</li>
      </ul>

      
<p>You still need the HCM module descriptor and config files (see Manual Setup below), but the annotation handles the repository wiring automatically.</p>
    </section>

    <section><a id="Manual_Setup_.28Legacy.29"></a>
<h1>Manual Setup (Legacy)</h1>
      
<p>For legacy abstract class tests or advanced customization, use manual Spring XML configuration:</p>

      <section><a id="a1._Add_HCM_Module_Descriptor"></a>
<h2>1. Add HCM Module Descriptor</h2>
        
<p><strong>File:</strong> <code>src/test/resources/META-INF/hcm-module.yaml</code></p>
        
<div class="brush: yaml">
          
<pre><code>
group:
  name: myproject-test
project: myproject-test
module:
  name: test-config
          </code></pre>
        </div>
        
<p><strong>Important:</strong> Do NOT include <code>config:</code> or <code>after:</code> sections.
        ModuleReader discovers config by directory convention.</p>
      </section>

      <section><a id="a2._Add_HCM_Configuration"></a>
<h2>2. Add HCM Configuration</h2>
        
<p><strong>Directory:</strong> <code>src/test/resources/hcm-config/hst/</code></p>
        
<p><strong>File:</strong> <code>demo-hst.yaml</code></p>
        
<div class="brush: yaml">
          
<pre><code>
definitions:
  config:
    /hst:myproject:
      jcr:primaryType: hst:hst
    /hst:myproject/hst:sites:
      jcr:primaryType: hst:sites
    /hst:myproject/hst:sites/myproject:
      jcr:primaryType: hst:site
      hst:content: /content/documents/myproject
    /hst:myproject/hst:configurations:
      jcr:primaryType: hst:configurations
    /hst:myproject/hst:configurations/myproject:
      jcr:primaryType: hst:configuration
    /hst:myproject/hst:configurations/myproject/hst:sitemap:
      jcr:primaryType: hst:sitemap
    /hst:myproject/hst:configurations/myproject/hst:sitemap/root:
      jcr:primaryType: hst:sitemapitem
      hst:componentconfigurationid: hst:pages/homepage
    /hst:myproject/hst:configurations/myproject/hst:pages:
      jcr:primaryType: hst:pages
    /hst:myproject/hst:configurations/myproject/hst:pages/homepage:
      jcr:primaryType: hst:component
    /hst:myproject/hst:hosts:
      jcr:primaryType: hst:virtualhosts
          </code></pre>
        </div>
        
<p><strong>Note:</strong> BRUT uses <code>/hst:myproject</code> as HST root (not <code>/hst:hst</code>) for test isolation.</p>
      </section>

      <section><a id="a3._Override_Repository_Bean"></a>
<h2>3. Override Repository Bean</h2>
        
<p><strong>File:</strong> <code>src/test/resources/org/example/config-service-jcr.xml</code></p>
        
<div class="brush: xml">
          
<pre><code>
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;
       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
       xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans
                           http://www.springframework.org/schema/beans/spring-beans-4.1.xsd&quot;&gt;

  &lt;bean id=&quot;javax.jcr.Repository&quot;
        class=&quot;org.bloomreach.forge.brut.resources.ConfigServiceRepository&quot;
        init-method=&quot;init&quot;
        destroy-method=&quot;close&quot;&gt;
    &lt;constructor-arg ref=&quot;cndResourcesPatterns&quot;/&gt;
    &lt;constructor-arg ref=&quot;contributedCndResourcesPatterns&quot;/&gt;
    &lt;constructor-arg ref=&quot;yamlResourcesPatterns&quot;/&gt;
    &lt;constructor-arg ref=&quot;contributedYamlResourcesPatterns&quot;/&gt;
    &lt;constructor-arg value=&quot;myproject&quot;/&gt;  &lt;!-- project namespace --&gt;
  &lt;/bean&gt;

&lt;/beans&gt;
          </code></pre>
        </div>
      </section>

      <section><a id="a4._Use_in_Your_Test"></a>
<h2>4. Use in Your Test</h2>
        
<div class="brush: java">
          
<pre><code>
@TestInstance(TestInstance.Lifecycle.PER_CLASS)
public class MyIntegrationTest extends AbstractJaxrsTest {

    @Override
    protected List&lt;String&gt; contributeSpringConfigurationLocations() {
        return Arrays.asList(
            &quot;/org/example/config-service-jcr.xml&quot;,  // ConfigServiceRepository override
            &quot;/org/example/custom-jaxrs.xml&quot;,
            &quot;/org/example/rest-resources.xml&quot;
        );
    }

    @Override
    protected String contributeHstConfigurationRootPath() {
        return &quot;/hst:myproject&quot;;  // BRUT uses project-specific root
    }

    @Test
    void testHstStructureCreated() throws Exception {
        Repository repo = getComponentManager().getComponent(Repository.class);
        Session session = repo.login(new SimpleCredentials(&quot;admin&quot;, &quot;admin&quot;.toCharArray()));

        assertTrue(session.nodeExists(&quot;/hst:myproject&quot;));
        assertTrue(session.nodeExists(&quot;/hst:myproject/hst:configurations/myproject&quot;));
    }
}
          </code></pre>
        </div>
      </section>

    </section>

    <section><a id="How_It_Works"></a>
<h1>How It Works</h1>

      <section><a id="Architecture"></a>
<h2>Architecture</h2>
        
<p>ConfigServiceRepository uses <strong>ModuleReader</strong> for explicit module loading:</p>
        
<div class="brush: plain">
          
<pre><code>
Test Resources (target/test-classes)
&#x251c;&#x2500;&#x2500; META-INF/hcm-module.yaml          &lt;- Module descriptor
&#x2514;&#x2500;&#x2500; hcm-config/                       &lt;- Config discovered by convention
    &#x2514;&#x2500;&#x2500; hst/*.yaml                    &lt;- Your HST definitions
                 |
           ModuleReader                &lt;- Loads module explicitly (no classpath scan)
                 |
    ConfigurationModelImpl.build()    &lt;- Builds configuration model
                 |
      ConfigurationConfigService      &lt;- brXM's production bootstrap service
                 |
          JCR Repository               &lt;- Production-identical structure
          </code></pre>
        </div>
        
<p><strong>Key Insight:</strong> We use <code>ModuleReader.read(path, false)</code> to load test modules
        explicitly by path, avoiding <code>ClasspathConfigurationModelReader</code> which scans for ALL modules
        (including framework JARs with unmet dependencies).</p>
      </section>

      <section><a id="Initialization_Flow"></a>
<h2>Initialization Flow</h2>
        
<ol style="list-style-type: decimal;">
          
<li><strong>Register CNDs</strong>: Node type definitions from classpath</li>
          
<li><strong>Load Test Modules</strong>: ModuleReader finds <code>META-INF/hcm-module.yaml</code> in <code>target/test-classes</code></li>
          
<li><strong>Discover Config</strong>: ModuleReader automatically finds <code>hcm-config/**/*.yaml</code></li>
          
<li><strong>Build Model</strong>: Creates <code>ConfigurationModelImpl</code> with only test modules</li>
          
<li><strong>Apply via ConfigService</strong>: Uses reflection to call package-private ConfigService methods</li>
          
<li><strong>Create JCR Nodes</strong>: ConfigService writes production-identical structure</li>
          
<li><strong>Import YAML Content</strong>: Additional content from YAML patterns</li>
          
<li><strong>Recalculate Paths</strong>: Update hippo:paths properties</li>
        </ol>
      </section>

    </section>

    <section><a id="HCM_Module_Format"></a>
<h1>HCM Module Format</h1>

      <section><a id="Correct_Format_.28ModuleReader.29"></a>
<h2>Correct Format (ModuleReader)</h2>
        
<div class="brush: yaml">
          
<pre><code>
# META-INF/hcm-module.yaml
group:
  name: test-group
project: test-project
module:
  name: test-config
  # NO 'config:' key here! ModuleReader discovers by convention.
          </code></pre>
        </div>
        
<p>ModuleReader automatically discovers:</p>
        
<ul>
          
<li><code>hcm-config/**/*.yaml</code> - Configuration</li>
          
<li><code>hcm-content/**/*.yaml</code> - Content</li>
          
<li><code>namespaces/**/*.cnd</code> - Node types</li>
        </ul>
      </section>

      <section><a id="Common_Mistakes"></a>
<h2>Common Mistakes</h2>
        
<div class="brush: yaml">
          
<pre><code>
# WRONG - config: key is invalid for ModuleReader
module:
  name: test-config
  config:              # &lt;- ERROR: Not valid!
    source: /hcm-config

# WRONG - Missing dependencies cause errors
group:
  name: test-group
  after:
    - hippo-cms       # &lt;- ERROR: hippo-cms doesn't exist in test env
          </code></pre>
        </div>
      </section>

      <section><a id="HCM_Config_Path_Format"></a>
<h2>HCM Config Path Format</h2>
        
<p>HCM config uses <strong>flat paths</strong>, not nested YAML:</p>
        
<div class="brush: yaml">
          
<pre><code>
# CORRECT - Flat paths
definitions:
  config:
    /hst:myproject:
      jcr:primaryType: hst:hst
    /hst:myproject/hst:sites:
      jcr:primaryType: hst:sites
    /hst:myproject/hst:sites/myproject:
      jcr:primaryType: hst:site

# WRONG - Nested structure (creates wrong paths)
definitions:
  config:
    /hst:myproject:
      jcr:primaryType: hst:hst
      /hst:sites:                    # Wrong: creates /hst:sites not /hst:myproject/hst:sites
        jcr:primaryType: hst:sites
          </code></pre>
        </div>
      </section>

    </section>

    <section><a id="Comparison.3A_SkeletonRepository_vs_ConfigServiceRepository"></a>
<h1>Comparison: SkeletonRepository vs ConfigServiceRepository</h1>
      
<table class="table table-striped">
        
<tr class="a">
<th>Aspect</th>
<th>SkeletonRepository</th>
<th>ConfigServiceRepository</th></tr>
        
<tr class="b">
<td>HST Bootstrap</td>
<td>Minimal hardcoded structure</td>
<td>Full production ConfigService</td></tr>
        
<tr class="a">
<td>Maintenance</td>
<td>Manual updates when brXM changes</td>
<td>Automatic (uses production code)</td></tr>
        
<tr class="b">
<td>Structure</td>
<td>Basic hst:hst node only</td>
<td>Complete HST tree</td></tr>
        
<tr class="a">
<td>Setup</td>
<td>Zero configuration</td>
<td>Requires HCM module + config</td></tr>
        
<tr class="b">
<td>Speed</td>
<td>Faster (minimal setup)</td>
<td>Slightly slower (full bootstrap)</td></tr>
        
<tr class="a">
<td>Use Case</td>
<td>Simple unit tests</td>
<td>Integration tests needing real HST</td></tr>
        
<tr class="b">
<td>Production Parity</td>
<td>No</td>
<td>Yes (exact same code path)</td></tr>
      </table>
    </section>

    <section><a id="Troubleshooting"></a>
<h1>Troubleshooting</h1>

      <section><a id="ParserException.3A_Key_.27config.27_is_not_allowed"></a>
<h2>ParserException: Key 'config' is not allowed</h2>
        
<p><strong>Cause:</strong> Using ClasspathConfigurationModelReader format in hcm-module.yaml</p>
        
<p><strong>Fix:</strong> Remove <code>config:</code> section. ModuleReader discovers by convention.</p>
      </section>

      <section><a id="MissingDependencyException.3A_missing_dependency_.27hippo-cms.27"></a>
<h2>MissingDependencyException: missing dependency 'hippo-cms'</h2>
        
<p><strong>Cause:</strong> Module declares dependency on framework module not present in test</p>
        
<p><strong>Fix:</strong> Remove <code>after:</code> section from group.</p>
      </section>

      <section><a id="HST_nodes_not_created"></a>
<h2>HST nodes not created</h2>
        
<p><strong>Cause:</strong> HCM config files missing or in wrong location</p>
        
<p><strong>Fix:</strong></p>
        
<ul>
          
<li>Verify <code>hcm-config/</code> directory exists in test resources</li>
          
<li>Check YAML syntax</li>
          
<li>Ensure paths use <code>/hst:myproject</code> (not <code>/hst:hst</code>)</li>
        </ul>
      </section>

    </section>

    <section><a id="Bootstrap_Strategy_Pattern"></a>
<h1>Bootstrap Strategy Pattern</h1>
      
<p>ConfigServiceRepository uses pluggable strategies:</p>
      
<ul>
        
<li><strong>ConfigServiceBootstrapStrategy</strong> - Uses ConfigService (preferred)
          
<ul>
            
<li>Auto-detects via <code>canHandle()</code> - checks for <code>META-INF/hcm-module.yaml</code></li>
            
<li>Loads modules explicitly with ModuleReader</li>
          </ul>
        </li>
        
<li><strong>ManualBootstrapStrategy</strong> - Minimal setup (fallback)
          
<ul>
            
<li>Always returns true for <code>canHandle()</code></li>
            
<li>Creates basic <code>/hst:hst</code> node only</li>
          </ul>
        </li>
      </ul>
      
<p>Strategy selection is automatic based on classpath resources.</p>
    </section>

    <section><a id="Example_Project_Structure"></a>
<h1>Example Project Structure</h1>
      
<div class="brush: plain">
        
<pre><code>
src/test/
&#x251c;&#x2500;&#x2500; java/org/example/
&#x2502;   &#x2514;&#x2500;&#x2500; MyIntegrationTest.java
&#x2514;&#x2500;&#x2500; resources/
    &#x251c;&#x2500;&#x2500; META-INF/
    &#x2502;   &#x2514;&#x2500;&#x2500; hcm-module.yaml              # Module descriptor
    &#x251c;&#x2500;&#x2500; hcm-config/
    &#x2502;   &#x2514;&#x2500;&#x2500; hst/
    &#x2502;       &#x2514;&#x2500;&#x2500; demo-hst.yaml            # HST configuration
    &#x2514;&#x2500;&#x2500; org/example/
        &#x2514;&#x2500;&#x2500; config-service-jcr.xml       # Repository override
        </code></pre>
      </div>
    </section>

  

    </div>
    </div>
    </div>
    <hr/>
    <footer>
    <div class="container-fluid">
      <div class="row-fluid">
          <p class="copyright">Copyright &copy;      2007&#x2013;${currentYear}
              <a href="https://www.bloomreach.com">Bloomreach</a>.
          
</p>
    </div>
            </div>
  </footer>
    </body>
</html>

